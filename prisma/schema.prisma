// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ------------------------------------------------------
// ENUMS
// ------------------------------------------------------

enum Role {
  ADMIN
  RECEPCAO
  PROFISSIONAL
}

enum AppointmentStatus {
  SCHEDULED
  COMPLETED
  CANCELED
}

enum PaymentMethod {
  PIX
  CREDIT_CARD
  DEBIT_CARD
  CASH
}

enum TabStatus {
  SCHEDULED
  IN_PROGRESS
  AWAITING_PAYMENT
  CLOSED
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum TransactionStatus {
  PENDING
  COMPLETED
}

enum CommissionStatus {
  PENDING
  PAID
}

enum PackageStatus {
  ACTIVE
  EXPIRED
  CONSUMED
}

enum ExpenseStatus {
  PENDING
  PAID
  OVERDUE
}

// ------------------------------------------------------
// MODELS
// ------------------------------------------------------

model Tenant {
  id   String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name String

  settings          TenantSettings?
  users             User[]
  customers         Customer[]
  services          Service[]
  serviceCategories ServiceCategory[]
  appointments      Appointment[]
  tabs              Tab[]
  tabItems          TabItem[]
  transactions      Transaction[]
  commissions       Commission[]
  customerRecords   CustomerRecord[]
  servicePackages   ServicePackage[]
  packageItems      PackageItem[]
  customerPackages  CustomerPackage[]
  packageUsages     CustomerPackageUsage[]
  expenses          Expense[]

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  blockouts Blockout[]
}

model TenantSettings {
  id       String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId String @unique @map("tenant_id") @db.Uuid

  businessHours Json?   @db.JsonB
  address       String?
  phone         String?
  logoUrl       String?

  // Configurações Públicas (Módulo 7)
  isPublicBookingEnabled Boolean @default(false)
  publicSlug             String? @unique
  bookingRules           Json?   @db.JsonB

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id           String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId     String  @map("tenant_id") @db.Uuid
  name         String
  email        String  @unique
  phone        String?
  passwordHash String
  role         Role    @default(RECEPCAO)
  isActive     Boolean @default(true)

  // Apenas relevante para role PROFISSIONAL
  commissionRate Decimal? @db.Decimal(5, 2)
  workingHours   Json?    @db.JsonB

  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  appointments Appointment[]
  tabItems     TabItem[]
  commissions  Commission[]

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  blockouts Blockout[]

  @@index([tenantId])
}

model Customer {
  id       String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId String  @map("tenant_id") @db.Uuid
  name     String
  phone    String?
  email    String?
  notes    String? @db.Text

  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  appointments     Appointment[]
  tabs             Tab[]
  record           CustomerRecord?
  customerPackages CustomerPackage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, name])
}

model CustomerRecord {
  id         String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId   String @map("tenant_id") @db.Uuid
  customerId String @unique @map("customer_id") @db.Uuid

  allergies      String?  @db.Text
  technicalNotes String?  @db.Text
  skinType       String?
  hairType       String?
  photosUrl      String[]
  lastUpdate     DateTime @default(now())

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
}

model ServiceCategory {
  id       String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId String @map("tenant_id") @db.Uuid
  name     String

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  services Service[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
}

model Service {
  id              String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId        String  @map("tenant_id") @db.Uuid
  categoryId      String? @map("category_id") @db.Uuid
  name            String
  price           Decimal @db.Decimal(10, 2)
  durationMinutes Int
  isActive        Boolean @default(true)

  tenant        Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  category      ServiceCategory?       @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  appointments  Appointment[]
  tabItems      TabItem[]
  packageItems  PackageItem[]
  packageUsages CustomerPackageUsage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
}

model Appointment {
  id             String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId       String            @map("tenant_id") @db.Uuid
  customerId     String            @db.Uuid
  professionalId String            @db.Uuid
  serviceId      String            @db.Uuid
  startTime      DateTime
  endTime        DateTime
  colorCode      String?
  status         AppointmentStatus @default(SCHEDULED)

  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer     Customer @relation(fields: [customerId], references: [id], onDelete: Restrict)
  professional User     @relation(fields: [professionalId], references: [id], onDelete: Restrict)
  service      Service  @relation(fields: [serviceId], references: [id], onDelete: Restrict)
  tab          Tab?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, startTime])
  @@index([professionalId, startTime])
}

model Tab {
  id            String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId      String         @map("tenant_id") @db.Uuid
  appointmentId String?        @unique @map("appointment_id") @db.Uuid
  customerId    String         @db.Uuid
  totalAmount   Decimal        @default(0) @db.Decimal(10, 2)
  tipAmount     Decimal        @default(0) @db.Decimal(10, 2)
  status        TabStatus      @default(SCHEDULED)
  paymentMethod PaymentMethod?

  tenant        Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  appointment   Appointment?           @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  customer      Customer               @relation(fields: [customerId], references: [id], onDelete: Restrict)
  items         TabItem[]
  transactions  Transaction[]
  packageUsages CustomerPackageUsage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
}

model TabItem {
  id             String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId       String  @map("tenant_id") @db.Uuid
  tabId          String  @db.Uuid
  serviceId      String? @db.Uuid
  professionalId String  @db.Uuid
  price          Decimal @db.Decimal(10, 2)

  tenant       Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tab          Tab         @relation(fields: [tabId], references: [id], onDelete: Cascade)
  service      Service?    @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  professional User        @relation(fields: [professionalId], references: [id], onDelete: Restrict)
  commission   Commission?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tabId])
}

model Transaction {
  id            String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId      String            @map("tenant_id") @db.Uuid
  tabId         String?           @db.Uuid
  type          TransactionType
  amount        Decimal           @db.Decimal(10, 2)
  paymentMethod PaymentMethod?
  status        TransactionStatus @default(COMPLETED)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tab    Tab?   @relation(fields: [tabId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tabId])
}

model Commission {
  id             String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId       String           @map("tenant_id") @db.Uuid
  professionalId String           @db.Uuid
  tabItemId      String           @unique @db.Uuid
  amount         Decimal          @db.Decimal(10, 2)
  status         CommissionStatus @default(PENDING)

  tenant       Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  professional User    @relation(fields: [professionalId], references: [id], onDelete: Restrict)
  tabItem      TabItem @relation(fields: [tabItemId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([professionalId, status])
}

// ------------------------------------------------------
// MÓDULO 8 — PACOTES, ASSINATURAS E DESPESAS
// ------------------------------------------------------

model ServicePackage {
  id           String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId     String  @map("tenant_id") @db.Uuid
  name         String
  description  String? @db.Text
  price        Decimal @db.Decimal(10, 2)
  validityDays Int
  isActive     Boolean @default(true)

  tenant Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  items  PackageItem[]
  sales  CustomerPackage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
}

model PackageItem {
  id        String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String @map("tenant_id") @db.Uuid
  packageId String @map("package_id") @db.Uuid
  serviceId String @map("service_id") @db.Uuid
  quantity  Int

  tenant  Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  package ServicePackage @relation(fields: [packageId], references: [id], onDelete: Cascade)
  service Service        @relation(fields: [serviceId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([packageId])
}

model CustomerPackage {
  id             String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId       String        @map("tenant_id") @db.Uuid
  customerId     String        @map("customer_id") @db.Uuid
  packageId      String        @map("package_id") @db.Uuid
  purchaseDate   DateTime      @default(now())
  expirationDate DateTime
  status         PackageStatus @default(ACTIVE)

  tenant   Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer Customer               @relation(fields: [customerId], references: [id], onDelete: Restrict)
  package  ServicePackage         @relation(fields: [packageId], references: [id], onDelete: Restrict)
  usages   CustomerPackageUsage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([customerId, status])
}

model CustomerPackageUsage {
  id                String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId          String  @map("tenant_id") @db.Uuid
  customerPackageId String  @map("customer_package_id") @db.Uuid
  serviceId         String  @map("service_id") @db.Uuid
  tabId             String? @map("tab_id") @db.Uuid
  appointmentId     String? @map("appointment_id") @db.Uuid

  tenant          Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customerPackage CustomerPackage @relation(fields: [customerPackageId], references: [id], onDelete: Cascade)
  service         Service         @relation(fields: [serviceId], references: [id], onDelete: Restrict)
  tab             Tab?            @relation(fields: [tabId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([customerPackageId])
}

model Expense {
  id          String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String        @map("tenant_id") @db.Uuid
  description String
  amount      Decimal       @db.Decimal(10, 2)
  category    String        @default("Outros")
  dueDate     DateTime
  paidDate    DateTime?
  status      ExpenseStatus @default(PENDING)
  notes       String?       @db.Text

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, dueDate])
}

model Blockout {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId       String   @map("tenant_id") @db.Uuid
  professionalId String   @db.Uuid
  startTime      DateTime
  endTime        DateTime
  reason         String?

  tenant       Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  professional User   @relation(fields: [professionalId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([professionalId, startTime])
}
